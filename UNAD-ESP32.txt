
// LIBRERIAS BLUETHOOH
#include <BTAddress.h>
#include <BTAdvertisedDevice.h>
#include <BTScan.h>
#include <BluetoothSerial.h>
#if !defined(CONFIG_BT_ENABLED) || !defined(CONFIG_BLUEDROID_ENABLED)
#error Bluetooth no está habilitado. Por favor, habilítalo en el menú de configuración de ESP32.
#endif
BluetoothSerial SerialBT;

// CONFIGURACION WIFI
#include <WiFiManager.h>  // <— NUEVO
#include <Preferences.h>  // Fuerza guardar las credenciales para proximos reinicios
#include <WiFi.h>
#include <ESP_Mail_Client.h>

//LIBRERIAS PANTALLA LCD Y DHT
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
LiquidCrystal_I2C lcd(0x26, 16, 2);

#include <DHT.h>
int SENSOR_DHT_PIN = 15;
DHT dht(SENSOR_DHT_PIN, DHT11);

String WIFI_SSID = "";
String WIFI_PASSWORD = "";
String AUTHOR_EMAIL = "";     // Tu Gmail
String AUTHOR_APP_PASS = "";  // Contraseña de aplicación (16 caracteres)
String RECIPIENT_EMAIL = "";  // A quién envías

// OBJETOS LIBRERIAS
SMTPSession smtp;
ESP_Mail_Session session;
SMTP_Message msg;
Preferences prefs;               // NVS (flash)
const char* NVS_NS = "mailcfg";  // espacio de nombres para guardar la info de correo desde WifiManager
bool BT_ON = false;

//----------------------------------------------------------------------------------------------------VARIABLES DE TODO EL SISTEMA


// VARIABLES PARA ASIGNACION DE PINES A LOS SENSORES
const int SENSOR_HUMEDAD_PIN = 35;  // Sensor de humedad tierra
const int SENSOR_NIVEL_PIN = 4;     // Sensor de agua vertical
const int RELAY_PIN = 23;           // Relay
const int SENSOR_LUZ_PIN = 33;
const int BUZZER_PIN = 32;
const int LAMPARA_PIN = 14;
const int LEDV = 27;
const int LEDR = 26;
const int BOTON_SELECT_PIN = 18;
const int BOTON_UP_PIN = 19;
const int BOTON_DOWN_PIN = 5;
const int BOTON_HOME_PIN = 13;

// VARIABLES DE OPERACION DE LOS SENSORES
int humedadDHT, temperatura;
int humedadSuelo;
int fotoresistor;
int nivelAgua;
int btnSelect;
int btnHome;

// VARIABLES DE LAS OPCIONES EDITABLES
int humedadedit = 30;
int temperaturaedit = 35;
int fotoresistoredit = 30;
int actualizador = 0;
bool luzmanual = false;
bool buzzermanual = false;
String estadoluz = "Auto";
String estadobuzzer = "Auto";
String estadonivel = "NO";

// VARIABLES CONDICIONALES PARA SALIR DE AUTO O MANUAL CON BOTON HOME
bool salirRA;
bool salirRM;

// VARIABLES PARA RECIBIR DATOS DESDE LA APP
char receivedChar;

// ESTRUCTURA DEL MENU DEL SISTEMA
String menuItems[] = { "Riego Auto", "Editar Humedad", "Editar Temp", "Editar Luz", "Bombilla", "Riego Manual", "Buzzer" };
int menuSize = sizeof(menuItems) / sizeof(menuItems[0]);
int currentMenuItem = 0;
int selectedItem = -1;

// SINCRONIZACION HORA PARA QUE TLS FUNCIONE
void syncTime() {
  configTime(-5 * 3600, 0, "pool.ntp.org", "time.nist.gov");  // Colombia GMT-5
  Serial.print("Sincronizando hora");
  time_t now = time(nullptr);
  int retries = 0;
  while (now < 8 * 3600 * 2 && retries < 30) {
    Serial.print(".");
    delay(500);
    now = time(nullptr);
    retries++;
  }
  Serial.println("\nHora OK.");
}
// CONFIGURACION DE ESTRUCTURA DEL CORREO
bool sendMail(const String& subject, const String& body) {
  if (WiFi.status() != WL_CONNECTED) {
    setupWiFi();
  }

  // apagar BT solo si estaba encendido
  bool disabledBT = false;
  if (BT_ON) {
    SerialBT.end();
    BT_ON = false;
    disabledBT = true;
    delay(50);
  }

  ESP_Mail_Session session;
  session.server.host_name = "smtp.gmail.com";
  session.server.port = 465;
  session.login.email = AUTHOR_EMAIL.c_str();
  session.login.password = AUTHOR_APP_PASS.c_str();
  session.secure.startTLS = false;  // porque usamos 465 (SSL)

  SMTPSession smtp;
  if (!smtp.connect(&session)) {
    Serial.print("Fallo conexion SMTP: ");
    Serial.println(smtp.errorReason().c_str());
    return false;
  }

  SMTP_Message msg;  // <--- mensaje LOCAL, nuevo cada vez
  msg.sender.name = "ESP32 Alertas";
  msg.sender.email = AUTHOR_EMAIL;
  msg.subject = subject;
  msg.addRecipient("Destino", RECIPIENT_EMAIL.c_str());
  msg.text.content = body.c_str();

  bool ok = MailClient.sendMail(&smtp, &msg, true);
  if (!ok) {
    Serial.print("Error al enviar: ");
    Serial.println(smtp.errorReason().c_str());
  } else {
    Serial.println("Correo enviado correctamente.");
  }
  smtp.closeSession();
  if (disabledBT) {
    SerialBT.begin("ESP32Nelson");
    BT_ON = true;
  }
  return ok;
}
// CONFIGURACION WIFI
void setupWiFi() {
  WiFi.mode(WIFI_STA);

  // pulsar HOME en el arranque fuerza portal
  bool forcePortal = (digitalRead(BOTON_HOME_PIN) == 0);

  WiFiManager wm;
  wm.setClass("invert");
  wm.setConfigPortalTimeout(180);
  // si tu versión lo soporta, deja esta línea; si no compila, coméntala:
  wm.setConnectRetries(3);
  wm.setWiFiAutoReconnect(true);

  // --- parámetros personalizados ---
  WiFiManagerParameter pAuthorEmail("author_email", "Correo remitente (AUTHOR_EMAIL)", AUTHOR_EMAIL.c_str(), 64);
  WiFiManagerParameter pAuthorAppPass("author_app_pass", "Clave de aplicacion SMTP (AUTHOR_APP_PASS)", AUTHOR_APP_PASS.c_str(), 64 /*, "type='password'" */);
  WiFiManagerParameter pRecipientEmail("recipient_email", "Correo destinatario (RECIPIENT_EMAIL)", RECIPIENT_EMAIL.c_str(), 64);

  wm.addParameter(&pAuthorEmail);
  wm.addParameter(&pAuthorAppPass);
  wm.addParameter(&pRecipientEmail);

  const char* apName = "ESP32-Garden";
  const char* apPass = "12345678";

  bool ok = false;
  if (forcePortal || !wm.getWiFiIsSaved()) {
    ok = wm.startConfigPortal(apName, apPass);
  } else {
    ok = wm.autoConnect(apName, apPass);
  }

  if (!ok) {
    Serial.println("No se pudo conectar/configurar WiFi (timeout).");
  } else {
    Serial.print("WiFi OK. IP: ");
    Serial.println(WiFi.localIP());
    WIFI_SSID = WiFi.SSID();
    WIFI_PASSWORD = WiFi.psk();

    // leer valores del portal y guardar en NVS
    String nA = String(pAuthorEmail.getValue());
    nA.trim();
    String nP = String(pAuthorAppPass.getValue());
    nP.trim();
    String nR = String(pRecipientEmail.getValue());
    nR.trim();
    if (nA.length()) AUTHOR_EMAIL = nA;
    if (nP.length()) AUTHOR_APP_PASS = nP;
    if (nR.length()) RECIPIENT_EMAIL = nR;

    saveMailConfigToNVS();

    Serial.println(String("[Mail] AUTHOR_EMAIL: ") + AUTHOR_EMAIL);
    Serial.println(String("[Mail] AUTHOR_APP_PASS: ") + maskTail(AUTHOR_APP_PASS));
    Serial.println(String("[Mail] RECIPIENT_EMAIL: ") + RECIPIENT_EMAIL);
  }

  WiFi.setSleep(false);
}
// PARAMETROS PARA LOS CAMPOS DE EMISOR, RECEPTOR, PASSWORD PARA LAS ALERTAS
void loadMailConfigFromNVS() {
  prefs.begin(NVS_NS, true);  // solo lectura
  String a = prefs.getString("a_email", "");
  String p = prefs.getString("a_pass", "");
  String r = prefs.getString("r_email", "");
  prefs.end();
  if (a.length()) AUTHOR_EMAIL = a;
  if (p.length()) AUTHOR_APP_PASS = p;
  if (r.length()) RECIPIENT_EMAIL = r;
}

void saveMailConfigToNVS() {
  prefs.begin(NVS_NS, false);  // escritura
  prefs.putString("a_email", AUTHOR_EMAIL);
  prefs.putString("a_pass", AUTHOR_APP_PASS);
  prefs.putString("r_email", RECIPIENT_EMAIL);
  prefs.end();
}

String maskTail(const String& s) {
  if (s.length() <= 4) return "****";
  return "****" + s.substring(s.length() - 4);
}
//_____________________________________________________________________________SETUP - SETUP__________________________________________________________________________________________
void setup() {
  //Configuracion de inicializacion Pantalla
  Wire.begin(21, 22); // sda es 21 y scl 22
  lcd.init();           // Inicializamos el LCD
  lcd.backlight();      // Activamos la luz de fondo
  lcd.clear();          // Limpiamos lo que haya en pantalla
  lcd.setCursor(0, 0);  // Iniciamos el cursor en el punto 0,0
  Serial.begin(9600);

  //Configuracion de inicializacion Botones
  pinMode(BOTON_SELECT_PIN, INPUT_PULLUP);
  pinMode(BOTON_UP_PIN, INPUT_PULLUP);
  pinMode(BOTON_DOWN_PIN, INPUT_PULLUP);
  pinMode(BOTON_HOME_PIN, INPUT_PULLUP);

  //Configuracion de inicializacion WIFI
  loadMailConfigFromNVS();  // ← carga valores guardados (si existen)
  setupWiFi();
  syncTime();

  SerialBT.begin("ESP32Nelson");  //Inicializa Bluethooth
  BT_ON = true;

  dht.begin();
  pinMode(SENSOR_HUMEDAD_PIN, INPUT_PULLUP);  // Sensor de humedad
  pinMode(SENSOR_LUZ_PIN, INPUT);
  pinMode(SENSOR_NIVEL_PIN, INPUT_PULLUP);  // Sensor de agua vertical
  pinMode(RELAY_PIN, OUTPUT);
  pinMode(LAMPARA_PIN, OUTPUT);
  pinMode(LEDV, OUTPUT);
  pinMode(LEDR, OUTPUT);

  digitalWrite(RELAY_PIN, HIGH);
  displayMenu();
}
//_____________________________________________________________________________LOOP - LOOP_____________________________________________________________________________
void loop() {
  ////////////////////////////////////////////////////////////////////////// CONDICIONALES DE SALIDA MENU AUTO Y MANUAL///////////////////////////////////////////////////////////
  if (salirRA == true) {
    displayMenu();
    delay(200);
  }

  if (salirRM == true) {
    displayMenu();
    delay(200);
  }

  /////////////////////////////////////////////////////////////////////// NAVEGACION DE BOTONES///////////////////////////////////////////////////////////////////////////////////
  if (digitalRead(BOTON_SELECT_PIN) == 0)  // BOTON SELECCIONAR
  {
    delay(50);  // Debounce
    if (selectedItem == -1) {
      selectedItem = currentMenuItem;
    } else {
      selectedItem = -1;
    }
    displayMenu();
    delay(200);
  }

  //////////////////////////////////////////////////////////////////////////////////// BOTON ARRIBA
  if (digitalRead(BOTON_UP_PIN) == 0) {
    delay(50);  // Debounce
    if (selectedItem == -1) {
      currentMenuItem = (currentMenuItem - 1 + menuSize) % menuSize;
    } else {
      updateValue(1);
    }
    displayMenu();
    delay(200);
  }
  ///////////////////////////////////////////////////////////////////////////////////////// BOTON ABAJO
  if (digitalRead(BOTON_DOWN_PIN) == 0) {
    delay(50);  // Debounce
    if (selectedItem == -1) {
      currentMenuItem = (currentMenuItem + 1) % menuSize;
    } else {
      updateValue(-1);
    }
    displayMenu();
    delay(200);
  }

  //////////////////////////////////////////////////////////////////////////////////////////// ACTIVAR LECTURA PARA MONITOREO EN APLICACION
  if (SerialBT.connected())

  {
    activacionlectura();
    recepciondedatos();
  }
}
//_____________________________________________________________________________LECTOR DE SENSORES _____________________________________________________________________________

void leerSensores() {
  // Función dedicada a leer todos los sensores
  humedadDHT = dht.readHumidity();
  temperatura = dht.readTemperature();

  // Leer sensores analógicos
  humedadSuelo = map(analogRead(SENSOR_HUMEDAD_PIN), 4095, 1650, 0, 100);
  fotoresistor = map(analogRead(SENSOR_LUZ_PIN), 4095, 0, 0, 100);
  nivelAgua = digitalRead(SENSOR_NIVEL_PIN);
  if (nivelAgua == 1) {
    estadonivel = "OK";
  } else {
    estadonivel = "NO";
  }

  sincronizacion();
}
//_____________________________________________________________________________ SINCRONIZAR APLICACION MOVIL MONITOREO _____________________________________________________________________________
void sincronizacion() {

  SerialBT.print(humedadSuelo);
  SerialBT.print(";");
  SerialBT.print(fotoresistor);
  SerialBT.print(";");
  SerialBT.print(temperatura);
  SerialBT.print(";");
  SerialBT.print(humedadDHT);
  SerialBT.print(";");
  SerialBT.print(estadonivel);
  SerialBT.print(";");
  SerialBT.print(estadoluz);
  SerialBT.print(";");
  SerialBT.print(estadobuzzer);
  SerialBT.println(";");
  SerialBT.print(WIFI_SSID);
  SerialBT.println(";");
  SerialBT.print(WIFI_PASSWORD);
  SerialBT.println(";");
  SerialBT.print(AUTHOR_EMAIL);
  SerialBT.println(";");
  SerialBT.print(RECIPIENT_EMAIL);
  SerialBT.println(";");
  SerialBT.print(AUTHOR_APP_PASS);
  SerialBT.println(";");
}
//_____________________________________________________________________________SINCRONIZADOR APLICACION PARAMETROS EDITABLES _____________________________________________________________________________
void sincronizaredit() {
  SerialBT.print(humedadedit);
  SerialBT.print(";");
  SerialBT.print(temperaturaedit);
  SerialBT.print(";");
  SerialBT.print(fotoresistoredit);
  SerialBT.println(";");
}
//______________________________________________________________________________ACTIVADOR DE LECTURA PARA APLICACION (MARCANDO CASILLA DE MONITOREO EN LA APP) _______________________________________________________________________
void activacionlectura() {
  if (actualizador == 1) {
    leerSensores();
    delay(1000);
  } else {
    sincronizaredit();
    delay(1000);
  }
}
//______________________________________________________________________________RECEPCION DE DATOS DESDE APLICACION _______________________________________________________________________
void recepciondedatos() {
  if (SerialBT.available()) {

    receivedChar = SerialBT.read();  // Lee el carácter recibido
    if (receivedChar == '1')         // Entrada del boton Regar
    {
      digitalWrite(RELAY_PIN, LOW);
      delay(5000);
      digitalWrite(RELAY_PIN, HIGH);
    }

    if (receivedChar == '2')  // Activa el actualizador
    {
      actualizador = 1;
    } else if (receivedChar == '3')  // Desactiva el actualizador
    {
      actualizador = 0;
    }
    if (receivedChar == '4')  // Activa la bombilla
    {
      digitalWrite(LAMPARA_PIN, HIGH);
    } else if (receivedChar == '5')  // Desactiva la bombilla
    {
      digitalWrite(LAMPARA_PIN, LOW);
    }
    if (receivedChar == '6')  // Activa el Manual de la bombilla
    {
      estadoluz = "Manual";
      luzmanual = true;
    } else if (receivedChar == '7')  // Activa el auto de la bombilla
    {
      estadoluz = "Auto";
      luzmanual = false;
    }
    if (receivedChar == '8')  // Activa el Manual del buzzer
    {
      estadobuzzer = "Manual";
      buzzermanual = true;
    } else if (receivedChar == '9')  // Activa el auto del buzzer
    {
      estadobuzzer = "Auto";
      buzzermanual = false;
    }

    //////////////////////////////////////////////////////////////////////////// VALORES EDITABLES //////////////////////////////////////////////////////////////////////////////////

    if (receivedChar == 'a')  // Aumenta un valor  a Humedad suelo
    {
      humedadedit = humedadedit + 1;
    } else if (receivedChar == 'b')  // Disminuye un valor a Humedad suelo
    {
      humedadedit = humedadedit - 1;
    }
    if (receivedChar == 'c')  // Aumenta un valor a la temperatura
    {
      temperaturaedit = temperaturaedit + 1;
    } else if (receivedChar == 'd')  // Disminuye un valor a la temperatura
    {
      temperaturaedit = temperaturaedit - 1;
    }
    if (receivedChar == 'e')  // Aumenta un valor a la luz
    {
      fotoresistoredit = fotoresistoredit + 1;
    } else if (receivedChar == 'f')  // Disminuye un valor  a la luz
    {
      fotoresistoredit = fotoresistoredit - 1;
    }

    ////////////////////////////////////////////////////////////////////////// VALORES DE BOTONES WIFI Y ALERTAS ///////////////////////////////////////////////////////////////////////////////////
    if (receivedChar == '*') {
      // cerrar BT si estaba encendido
      bool disabledBT = false;
      if (BT_ON) {
        SerialBT.end();
        BT_ON = false;
        disabledBT = true;
        delay(100);
      }

      WiFiManager wm;
      wm.setConfigPortalTimeout(180);

      WiFiManagerParameter pAuthorEmail("author_email", "Correo remitente (AUTHOR_EMAIL)", AUTHOR_EMAIL.c_str(), 64);
      WiFiManagerParameter pAuthorAppPass("author_app_pass", "Clave de aplicacion SMTP (AUTHOR_APP_PASS)", AUTHOR_APP_PASS.c_str(), 64 /*, "type='password'" */);
      WiFiManagerParameter pRecipientEmail("recipient_email", "Correo destinatario (RECIPIENT_EMAIL)", RECIPIENT_EMAIL.c_str(), 64);
      wm.addParameter(&pAuthorEmail);
      wm.addParameter(&pAuthorAppPass);
      wm.addParameter(&pRecipientEmail);

      Serial.println("Abriendo portal WiFiManager...");
      bool ok = wm.startConfigPortal("ESP32-Garden", "12345678");

      if (disabledBT) {
        SerialBT.begin("ESP32Nelson");
        BT_ON = true;
      }

      if (ok) {
        WIFI_SSID = WiFi.SSID();
        WIFI_PASSWORD = WiFi.psk();

        String nA = String(pAuthorEmail.getValue());
        nA.trim();
        String nP = String(pAuthorAppPass.getValue());
        nP.trim();
        String nR = String(pRecipientEmail.getValue());
        nR.trim();
        if (nA.length()) AUTHOR_EMAIL = nA;
        if (nP.length()) AUTHOR_APP_PASS = nP;
        if (nR.length()) RECIPIENT_EMAIL = nR;
        saveMailConfigToNVS();

        Serial.println("[Portal] Datos actualizados.");
      } else {
        Serial.println("[Portal] Cancelado/timeout.");
      }
    }
  }
}
//_____________________________________________________________________________ DISPLAY MENU -DISPLAY MENU _____________________________________________________________________________

void displayMenu() {
  salirRA = false;
  salirRM = false;
  int ValidadorCorreoT = 0;
  int ValidadorCorreoR = 0;
  int ValidadorCorreoL = 0;
  int ValidadorCorreoTemp = 0;
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print(menuItems[currentMenuItem]);
  Serial.println(menuItems[currentMenuItem]);  //////////////////////////

  if (selectedItem != -1) {
    lcd.setCursor(0, 1);

    switch (selectedItem) {

        // VALORES PERSONALIZADOS
      case 0:
        while (salirRA == false) {
          leerSensores();

          lcd.clear();
          lcd.setCursor(0, 0);
          lcd.print("HS ");
          lcd.print(humedadSuelo);
          lcd.setCursor(6, 0);
          lcd.print("%");
          Serial.print("HS ");
          Serial.print(humedadSuelo);
          Serial.print("%");  //////////////////////////
          lcd.setCursor(0, 1);
          lcd.print("LZ ");
          lcd.print(fotoresistor);
          lcd.setCursor(6, 1);
          lcd.print("%");
          Serial.print(" LZ ");
          Serial.print(fotoresistor);
          Serial.println("%");  //////////////////////////
          lcd.setCursor(8, 0);
          lcd.print("TM ");
          lcd.print(temperatura);
          lcd.setCursor(14, 0);
          lcd.print("C");
          Serial.print("TM ");
          Serial.print(temperatura);
          Serial.print("C");  //////////////////////////
          lcd.setCursor(8, 1);
          lcd.print("HA ");
          lcd.print(humedadDHT);
          lcd.setCursor(14, 1);
          lcd.print("%");
          Serial.print(" HA ");
          Serial.print(humedadDHT);
          Serial.println("%");  //////////////////////////
          Serial.println("/////////////////////");

          delay(1000);

          /////////////////////////////////////////////////////////////////////////////////////////////// CONDICIONAL PARA EL RIEGO AUTOMATIZADO
          if ((humedadSuelo <= humedadedit) && (nivelAgua == 1)) {
            lcd.clear();
            digitalWrite(RELAY_PIN, LOW);
            lcd.setCursor(0, 0);
            lcd.print("SUMINISTRANDO");
            Serial.print("SUMINISTRANDO");  //////////////////////////
            lcd.setCursor(0, 1);
            lcd.print("AGUA");
            Serial.println(" AGUA");                  //////////////////////////
            Serial.println("/////////////////////");  //////////////////////////
            delay(5000);
            digitalWrite(RELAY_PIN, HIGH);
            if (ValidadorCorreoR == 0) {
              sendMail("ALERTA INFORMATIVA: Suministro de agua", "NIVEL DE HUMEDAD DETECTADO = " + String(humedadSuelo));
              ValidadorCorreoR = 1;
            }
            lcd.clear();
          } else {
            ValidadorCorreoR = 0;
            digitalWrite(RELAY_PIN, HIGH);
          }

          if ((humedadSuelo <= humedadedit) && (nivelAgua == 0)) {
            lcd.clear();
            digitalWrite(RELAY_PIN, HIGH);
            lcd.setCursor(0, 0);
            lcd.print("EL TANQUE NO");
            Serial.print("EL TANQUE NO");  //////////////////////////
            lcd.setCursor(0, 1);
            lcd.print("TIENE AGUA");
            Serial.println(" TIENE AGUA");            //////////////////////////
            Serial.println("/////////////////////");  //////////////////////////
            delay(5000);

            if (ValidadorCorreoT == 0) {
              sendMail("ALERTA CRITICA: Tanque vacio", "ESTADO DEL TANQUE ACTUAL = " + String(nivelAgua));
              ValidadorCorreoT = 1;
            }
            lcd.clear();
          } else {
            ValidadorCorreoT = 0;
          }

          ////////////////////////////////////////////////////////////////////////////////////////////////// CONDICIONAL PARA LA LAMPARA

          if ((fotoresistor <= fotoresistoredit) && (luzmanual == false)) {
            digitalWrite(LAMPARA_PIN, HIGH);
            if (ValidadorCorreoL == 0) {
              sendMail("ALERTA INFORMATIVA: Lampara de apoyo encendida", "NIVEL DE LUZ DETECTADO = " + String(fotoresistor));
              ValidadorCorreoL = 1;
            }
          } else {
            ValidadorCorreoL = 0;
          }
          if ((fotoresistor > fotoresistoredit) && (luzmanual == false)) {
            digitalWrite(LAMPARA_PIN, LOW);
          } else {
          }

          if (digitalRead(BOTON_UP_PIN) == LOW) {
            digitalWrite(LAMPARA_PIN, HIGH);
          } else {
          }

          if (digitalRead(BOTON_DOWN_PIN) == LOW) {
            digitalWrite(LAMPARA_PIN, LOW);
          } else {
          }

          /////////////////////////////////////////////////////////////////////////////////////////////////////////// CONDICIONAL DE LA TEMPERATURA

          if (temperatura > temperaturaedit) {
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("LA TEMPERATURA");
            Serial.print("LA TEMPERATURA");  //////////////////
            lcd.setCursor(0, 1);
            lcd.print("ES MUY ALTA");
            Serial.println(" ES MUY ALTA");
            Serial.println("/////////////////////");  //////////////////////////
            delay(5000);
            if (ValidadorCorreoTemp == 0) {
              sendMail("ALERTA CRITICA: Alta temperatura", "NIVEL DE TEMPERATURA DETECTADO = " + String(temperatura));
              ValidadorCorreoTemp = 1;
            }
            lcd.clear();
          } else {
            ValidadorCorreoTemp = 0;
          }

          /////////////////////////////////////////////////////////////////////////////////////////////////////////////////// CONDICIONAL LEDS

          if ((temperatura < temperaturaedit) && (nivelAgua == 1)) {
            digitalWrite(LEDR, LOW);   // rojo
            digitalWrite(LEDV, HIGH);  // verde
            noTone(BUZZER_PIN);
          } else {
            digitalWrite(LEDR, HIGH);
            digitalWrite(LEDV, LOW);
            lcd.clear();
            lcd.setCursor(0, 0);
            lcd.print("SIN SUMINISTRO");
            Serial.print("SIN SUMINISTRO");  //////////////////
            lcd.setCursor(0, 1);
            lcd.print("DE AGUA");

            Serial.println(" DE AGUA");
            Serial.println("/////////////////////");  //////////////////////////
            if (buzzermanual == false) {
              tone(BUZZER_PIN, 100);
              delay(2000);
              noTone(BUZZER_PIN);
            } else {
              noTone(BUZZER_PIN);
            }
          }

          if (digitalRead(BOTON_HOME_PIN) == LOW) {
            digitalWrite(LEDR, LOW);
            digitalWrite(LEDV, LOW);
            digitalWrite(LAMPARA_PIN, LOW);
            noTone(BUZZER_PIN);
            salirRA = true;
            selectedItem = -1;
            delay(2000);
          } else {
          }
        }
        break;

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

      case 1:
        lcd.print("Humedad: " + String(humedadedit) + "%");
        Serial.println("Humedad: " + String(humedadedit) + "%");  //////////////////////////
        break;
      case 2:
        lcd.print("Temp: " + String(temperaturaedit) + "C");
        Serial.println("Temp: " + String(temperaturaedit) + "C");  //////////////////////////
        break;
      case 3:

        lcd.print("Nivel de luz: " + String(fotoresistoredit) + "%");
        Serial.println("Nivel de luz: " + String(fotoresistoredit) + "%");  //////////////////////////
        break;
      case 4:

        lcd.print("Lampara: " + String(estadoluz));
        Serial.println("Lampara: " + String(estadoluz));  ////////////
        if (digitalRead(BOTON_UP_PIN) == LOW) {
          estadoluz = "Auto";
          luzmanual = false;
          lcd.clear();
          lcd.print("Auto Activado..");
          Serial.println("Auto Activado..");  /////////////////
          delay(2000);
          loop();
        }

        if (digitalRead(BOTON_DOWN_PIN) == LOW) {
          estadoluz = "Manual";
          luzmanual = true;
          lcd.clear();
          lcd.print("Manual activado");
          Serial.println("Manual activado");  ////////////////
          delay(2000);
          loop();
        }

        break;

      case 5:

        while (salirRM == false) {
          leerSensores();

          lcd.clear();
          lcd.setCursor(0, 0);
          lcd.print("Humedad HS ");
          Serial.print("Humedad HS ");  ///////////////
          lcd.print(humedadSuelo);
          Serial.print(humedadSuelo);  ///////////////
          lcd.setCursor(15, 0);
          lcd.print("%");
          Serial.println("%");  /////////
          lcd.setCursor(0, 1);
          lcd.print("Nivel Tanque " + String(estadonivel));
          Serial.println("Nivel Tanque " + String(estadonivel));  /////////
          Serial.println("/////////////////////");                //////////////////////////
          delay(1000);

          if ((digitalRead(BOTON_HOME_PIN) == LOW) && (nivelAgua == 1)) {

            lcd.clear();
            digitalWrite(RELAY_PIN, LOW);
            lcd.setCursor(0, 0);
            lcd.print("SUMINISTRANDO");
            Serial.print("SUMINISTRANDO");  //////////////////////////
            lcd.setCursor(0, 1);
            lcd.print("AGUA");
            Serial.println(" AGUA");                  //////////////////////////
            Serial.println("/////////////////////");  //////////////////////////
            delay(5000);
            digitalWrite(RELAY_PIN, HIGH);
            lcd.clear();
          }
          if ((digitalRead(BOTON_HOME_PIN) == LOW) && (nivelAgua == 0)) {
            lcd.clear();
            digitalWrite(RELAY_PIN, HIGH);
            lcd.setCursor(0, 0);
            lcd.print("EL TANQUE NO");
            Serial.print("EL TANQUE NO");  //////////////////////////
            lcd.setCursor(0, 1);
            lcd.print("TIENE AGUA");
            Serial.println(" TIENE AGUA");            //////////////////////////
            Serial.println("/////////////////////");  //////////////////////////
            delay(5000);
            lcd.clear();
          }
          if (digitalRead(BOTON_SELECT_PIN) == LOW) {
            salirRM = true;
            selectedItem = -1;
            delay(2000);
          }
        }

        break;

      case 6:
        lcd.print("Buzzer: " + String(estadobuzzer));
        Serial.println("Buzzer: " + String(estadobuzzer));  ////////////
        if (digitalRead(BOTON_UP_PIN) == LOW) {
          estadobuzzer = "Auto";
          buzzermanual = false;
          lcd.clear();
          lcd.print("Auto Activado..");
          Serial.println("Auto Activado..");  /////////////////
          delay(2000);
          loop();
        }

        if (digitalRead(BOTON_DOWN_PIN) == LOW) {
          estadobuzzer = "Manual";
          buzzermanual = true;
          lcd.clear();
          lcd.print("Manual activado");
          Serial.println("Manual activado");  ////////////////
          delay(2000);
          loop();
        }
        break;
    }
  }
}

//_____________________________________________________________________________INTERVALOS DE MODIFICACION _____________________________________________________________________________

void updateValue(int direction) {
  switch (selectedItem) {
    case 1:
      humedadedit = constrain(humedadedit + direction, 0, 100);
      break;
    case 2:
      temperaturaedit = constrain(temperaturaedit + direction, -49, 125);
      break;
    case 3:
      fotoresistoredit = constrain(fotoresistoredit + direction, 0, 100);
      break;
  }
}
